<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Matrix Terminal — TREVSHADOW</title>
<style>
  html, body { margin:0; height:100%; background:#000; overflow:hidden; }
  canvas { display:block; width:100vw; height:100vh; }
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha:false });

  /* =================== DIALS =================== */
  const CELL = 16;
  const FPS_MS = 88;

  const CEILING_ROWS = 3;
  const TRANSITION_ROWS = 7;

  const RAIN_PASSES = 3;
  const SPEED_MIN = 1;
  const SPEED_MAX = 3;

  const TRAIL_ALPHA = 0.05;

  const TAIL_LIVE_CELLS = 26;
  const TAIL_SPREAD_STEP = 1;

  const SLOW_TOP_FRAC = 0.33;
  const TOP_MULT = 0.22;
  const MID_MULT = 0.55;
  const BOTTOM_FADE_FRAC = 0.10;

  /* ============== COLORS ============== */
  const BODY_DARK  = "#0b6b2a";
  const BODY_MID   = "#00b84a";
  const BODY_GREEN = "#00ff66";
  const HEAD_COLORS = ["#00ff66", "#00ffd5", "#ff4dff", "#ffe14d", "#ffffff"];

  /* ============== CHARSETS ============== */
  const MATRIX_CHARS =
    "ｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜ" +
    "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ" +
    "!@#$%^&*()_+-=[]{};:,.<>/?";

  const CODE_TOKENS = [
    "const","let","function","return","tick()","resize()",
    "speedMultiplierForY","bottomFadeAlpha",
    "Math.random()","requestAnimationFrame",
    "TREVSHADOW",">.<","ctx.fillRect","canvas","CELL","FPS_MS"
  ];

  const rand = a => a[(Math.random()*a.length)|0];
  const randChar = () => rand(MATRIX_CHARS);
  const randHeadColor = () => rand(HEAD_COLORS);

  /* ============== STATE ============== */
  let W=0, H=0, dpr=1;
  let drops=[], speed=[], acc=[];
  let frame=0;

  function resize(){
    dpr = Math.max(1, window.devicePixelRatio||1);
    canvas.width  = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.font = `${CELL}px monospace`;
    ctx.textBaseline="top";

    W = Math.floor(innerWidth / CELL);
    H = Math.floor(innerHeight / CELL);

    drops.length = speed.length = acc.length = W;
    for(let x=0;x<W;x++){
      drops[x]=(Math.random()*H)|0;
      speed[x]=SPEED_MIN+((Math.random()*(SPEED_MAX-SPEED_MIN+1))|0);
      acc[x]=0;
    }
  }

  function speedMult(y){
    const p=y/Math.max(1,H-1);
    if(p<=SLOW_TOP_FRAC) return TOP_MULT;
    const t=(p-SLOW_TOP_FRAC)/(1-SLOW_TOP_FRAC);
    return TOP_MULT+(MID_MULT-TOP_MULT)*(t*t);
  }

  function bottomFade(y){
    const p=y/Math.max(1,H-1);
    if(p<=1-BOTTOM_FADE_FRAC) return 1;
    return Math.max(0,1-(p-(1-BOTTOM_FADE_FRAC))/BOTTOM_FADE_FRAC);
  }

  function rainAlpha(y){
    if(y>=CEILING_ROWS) return 1;
    return Math.min(1,(y+1)/TRANSITION_ROWS);
  }

  function whisper(){
    if(Math.random()>0.06) return;
    const token=rand(CODE_TOKENS);
    const y=(Math.random()*Math.min(H*0.5,12))|0;
    const x=(Math.random()*(W-token.length))|0;
    ctx.globalAlpha=0.18;
    ctx.fillStyle=BODY_DARK;
    ctx.fillText(token,x*CELL,y*CELL);
    ctx.globalAlpha=1;
  }

  let last=performance.now(), accTime=0;
  const MAX_TICKS=6;

  function loop(now){
    accTime+=Math.min(now-last,200);
    last=now;
    let ticks=0;
    while(accTime>=FPS_MS && ticks<MAX_TICKS){
      tick();
      accTime-=FPS_MS;
      ticks++;
    }
    if(ticks>=MAX_TICKS) accTime=0;
    requestAnimationFrame(loop);
  }

  function tick(){
    // ✅ FIXED rectangle issue: clear using canvas size in CSS pixels
    ctx.fillStyle=`rgba(0,0,0,${TRAIL_ALPHA})`;
    ctx.fillRect(0,0,canvas.width/dpr,canvas.height/dpr);

    whisper();

    for(let p=0;p<RAIN_PASSES;p++){
      for(let x=0;x<W;x++){
        if(frame%speed[x]) continue;
        const y=drops[x];

        for(let t=0;t<TAIL_LIVE_CELLS;t+=TAIL_SPREAD_STEP){
          const yy=y-t;
          if(yy<0||yy>=H) continue;
          let col=BODY_DARK;
          if(t===0) col=randHeadColor();
          else if(t<3) col=BODY_GREEN;
          else if(t<7) col=BODY_MID;
          ctx.globalAlpha=rainAlpha(yy)*bottomFade(yy);
          ctx.fillStyle=col;
          ctx.fillText(Math.random()<0.2?rand(CODE_TOKENS)[0]:randChar(),x*CELL,yy*CELL);
        }
        ctx.globalAlpha=1;

        acc[x]+=speedMult(y);
        if(acc[x]>=1){
          drops[x]+=acc[x]|0;
          acc[x]%=1;
        }
        if(drops[x]>H+TAIL_LIVE_CELLS) drops[x]=0;
      }
    }
    frame++;
  }

  addEventListener("resize",resize);
  resize();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
